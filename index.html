<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Better Beggars — Donate</title>

<!-- Stripe.js (client) -->
<script src="https://js.stripe.com/v3/"></script>

<style>
  :root {
    --accent: #0570de;
    --muted: #f4f6fb;
    --card: #ffffff;
    --text: #1f2937;
  }
  body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: var(--muted); color: var(--text); margin:0; padding:0; }
  .container { max-width: 980px; margin: 36px auto; padding: 0 20px; }

  header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:22px; }
  .brand { display:flex; align-items:center; gap:12px; text-decoration:none; color:var(--text); }
  .brand .logo { width:48px; height:48px; border-radius:10px; background:linear-gradient(135deg,#4b6bd6,#2ec9b7); display:flex; align-items:center; justify-content:center; color:white; font-weight:700; font-size:18px; }
  .brand h1 { margin:0; font-size:20px; letter-spacing:-0.2px; }

  /* Carousel */
  .carousel { position:relative; border-radius:12px; overflow:hidden; background:#fff; box-shadow:0 8px 30px rgba(16,24,40,0.08); }
  .slides { display:flex; transition: transform 0.6s ease; will-change:transform; }
  .slide { min-width:100%; padding:40px; box-sizing:border-box; display:flex; gap:20px; align-items:center; }
  .slide .content { max-width:520px; }
  .slide h2 { margin:0 0 8px 0; font-size:28px; color:var(--text); }
  .slide p { margin:0 0 12px 0; color:#475569; line-height:1.45; }
  .slide img { width:320px; height:auto; border-radius:10px; object-fit:cover; }

  /* Controls */
  .carousel .controls { position:absolute; inset:auto 14px 14px 14px; display:flex; justify-content:space-between; align-items:center; pointer-events:none; }
  .btn { pointer-events:auto; background:var(--card); border:none; padding:10px 14px; border-radius:10px; cursor:pointer; box-shadow:0 4px 12px rgba(16,24,40,0.06); }
  .dots { display:flex; gap:8px; }
  .dot { width:10px; height:10px; border-radius:999px; background:rgba(16,24,40,0.12); cursor:pointer; }
  .dot.active { background:var(--accent); }

  /* Two-column area */
  .grid { display:grid; grid-template-columns: 1fr 360px; gap:20px; margin-top:20px; }
  @media(max-width:900px) { .grid { grid-template-columns:1fr; } .slide img{display:none;} }

  .card { background:var(--card); padding:18px; border-radius:12px; box-shadow:0 6px 18px rgba(16,24,40,0.06); }
  .donate-cta { display:flex; gap:12px; align-items:center; justify-content:center; margin-bottom:12px; }
  .donate-cta a, .donate-cta button { padding:12px 18px; border-radius:10px; border:none; font-weight:600; text-decoration:none; }
  .primary { background:var(--accent); color:white; }
  .secondary { background:#eef6ff; color:var(--accent); border:1px solid rgba(5,112,222,0.08); }

  /* Payment element area */
  #payment-form { margin-top:12px; }
  #payment-message { display:none; padding:12px; margin-top:8px; border-radius:8px; background:#f8fafc; color:#111827; }

  /* Past donors popup */
  #popupOverlay { display:none; position:fixed; inset:0; background:rgba(2,6,23,0.5); z-index:999; }
  #donorPopup { display:none; position:fixed; left:50%; top:14%; transform:translateX(-50%); width:90%; max-width:420px; z-index:1000; }
  #donorPopup .card { max-height:70vh; overflow:auto; padding:18px; }
  #donorList { list-style:none; margin:0; padding:0; }
  #donorList li { padding:10px 8px; border-bottom:1px dashed #eef2ff; display:flex; justify-content:space-between; gap:8px; }
  #donorList li:last-child { border-bottom:none; }

  footer { margin-top:28px; color:#64748b; font-size:13px; text-align:center; }
</style>
</head>
<body>
  <div class="container">
    <header>
      <a class="brand" href="#">
        <div class="logo">BB</div>
        <div>
          <h1>Better Beggars</h1>
          <div style="font-size:12px;color:#64748b;">Help a person. Change a life.</div>
        </div>
      </a>
      <div style="display:flex;gap:10px;align-items:center;">
        <!-- Quick donate via Stripe Payment Link -->
        <a class="btn primary" href="https://buy.stripe.com/5kQ28q9rb1pc4963l567S00" target="_blank" rel="noopener">Donate (Stripe Link)</a>
        <button class="btn secondary" onclick="showDonors()">Past donors</button>
      </div>
    </header>

    <!-- Carousel -->
    <div class="carousel card" id="carousel">
      <div class="slides" id="slides">
        <div class="slide">
          <div class="content">
            <h2>Give a warm meal today</h2>
            <p>Just a small gift can provide someone a meal and dignity. Tap donate to help now — or donate on-site without leaving this page.</p>
            <div style="margin-top:12px;">
              <a class="primary" href="https://buy.stripe.com/5kQ28q9rb1pc4963l567S00" target="_blank">Donate with Stripe Link</a>
              <button style="margin-left:10px;" class="secondary" onclick="scrollToPayment()">Donate on this page</button>
            </div>
          </div>
          <img alt="" src="https://images.unsplash.com/photo-1523475496153-3d6cc0a15b20?q=80&w=1200&auto=format&fit=crop&ixlib=rb-4.0.3&s=9b54c18f0bcfbb04dfeaf1d2fe5f36a6">
        </div>

        <div class="slide">
          <div class="content">
            <h2>Every donation is tracked</h2>
            <p>We log donations and display recent donors (name + amount) to build trust and encourage others. Your privacy is respected — donors can be anonymous.</p>
          </div>
          <img alt="" src="https://images.unsplash.com/photo-1505751172876-fa1923c5c528?q=80&w=1200&auto=format&fit=crop&ixlib=rb-4.0.3&s=273ad3f1155d8c4b4a5f8b5f4b1e5c3e">
        </div>

        <div class="slide">
          <div class="content">
            <h2>Make it local</h2>
            <p>Scan the QR on the person’s card or choose a direct donation link. We make sure funds are tracked to the right recipient.</p>
          </div>
          <img alt="" src="https://images.unsplash.com/photo-1524504388940-b1c1722653e1?q=80&w=1200&auto=format&fit=crop&ixlib=rb-4.0.3&s=9b5e3e1f7f86e492a6a5f8f336e7a266">
        </div>
      </div>

      <div class="controls">
        <div>
          <button class="btn" id="prevBtn" aria-label="Previous">◀</button>
        </div>
        <div style="display:flex;align-items:center;gap:12px;">
          <div class="dots" id="dots"></div>
        </div>
      </div>
    </div>

    <!-- Main grid: site payment & info -->
    <div class="grid">
      <div>
        <div class="card" id="paymentCard">
          <h3 style="margin-top:0">Donate on this page</h3>
          <p style="color:#475569;margin-top:6px;">Use our secure Stripe checkout embedded below. Enter amount, card details and complete payment without leaving.</p>

          <!-- Payment Element placeholder -->
          <form id="payment-form">
            <div id="payment-element"></div>
            <div style="display:flex;gap:8px;margin-top:12px;">
              <input id="amount" type="number" placeholder="Amount (AUD cents)" style="flex:1;padding:10px;border-radius:8px;border:1px solid #e6edf7" />
              <button id="submit" class="primary" style="padding:10px 14px;">Pay on site</button>
            </div>
            <div id="payment-message"></div>
          </form>

          <div style="margin-top:12px;color:#64748b;font-size:13px;">
            Or use the quick Stripe link at the top to open the hosted payment page.
          </div>
        </div>

        <div style="margin-top:14px;" class="card">
          <h3 style="margin-top:0">Why we show donors</h3>
          <p style="color:#475569;">Seeing past donors builds trust. Donors can choose to be anonymous; we only display info saved through Stripe (name & amount) or entered manually.</p>
        </div>
      </div>

      <!-- Right column: QR / Info -->
      <aside>
        <div class="card">
          <h3 style="margin-top:0">Donate quickly</h3>
          <p style="color:#475569;margin-bottom:10px;">Open the Stripe payment link, or scan a QR on a person’s card (we recommend creating one link per person to track payments).</p>
          <a class="primary" href="https://buy.stripe.com/5kQ28q9rb1pc4963l567S00" target="_blank" style="display:inline-block;width:100%;text-align:center;">Open Stripe Link</a>
          <div style="text-align:center;margin-top:12px;color:#94a3b8;font-size:13px;">
            Or scan:
            <div style="margin-top:8px;">
              <!-- small inline QR generated via Google Chart API for the Stripe link -->
              <img src="https://chart.googleapis.com/chart?chs=150x150&cht=qr&chl=https://buy.stripe.com/5kQ28q9rb1pc4963l567S00" alt="QR" style="border-radius:8px;box-shadow:0 6px 18px rgba(16,24,40,0.06);" />
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <h4 style="margin-top:0">Recent donors</h4>
          <ul id="miniDonors" style="list-style:none;padding:0;margin:0;font-size:14px;color:#475569;"></ul>
          <div style="margin-top:8px;text-align:center;color:#94a3b8;font-size:12px;">(Full list in popup)</div>
        </div>
      </aside>
    </div>

    <footer>
      Built with ♥ · Hosted locally for testing. To accept live payments, use your real Stripe keys and set a webhook URL.
    </footer>
  </div>

  <!-- Past donors popup -->
  <div id="popupOverlay" onclick="closePopup()"></div>
  <div id="donorPopup">
    <div class="card">
      <h3 style="margin:0 0 8px 0;">Past Donors</h3>
      <ul id="donorList"></ul>
      <div style="text-align:right;margin-top:10px;">
        <button onclick="closePopup()" class="btn">Close</button>
      </div>
    </div>
  </div>

<script>
/* ------------------- Carousel ------------------- */
(function(){
  const slides = document.getElementById('slides');
  const slideCount = slides.children.length;
  let index = 0;
  const dots = document.getElementById('dots');

  function renderDots(){
    dots.innerHTML = '';
    for(let i=0;i<slideCount;i++){
      const dot = document.createElement('div');
      dot.className = 'dot' + (i===0?' active':'');
      dot.addEventListener('click', ()=> { goto(i); });
      dots.appendChild(dot);
    }
  }

  function goto(i){
    index = i;
    slides.style.transform = `translateX(-${index*100}%)`;
    Array.from(dots.children).forEach((d, idx)=> d.classList.toggle('active', idx===index));
  }

  document.getElementById('prevBtn').addEventListener('click', ()=> goto((index-1+slideCount)%slideCount));
  // auto play
  let autoplay = setInterval(()=> goto((index+1)%slideCount), 5000);

  // pause on hover
  const carousel = document.getElementById('carousel');
  carousel.addEventListener('mouseenter', ()=> clearInterval(autoplay));
  carousel.addEventListener('mouseleave', ()=> autoplay = setInterval(()=> goto((index+1)%slideCount), 5000));

  renderDots();
})();

/* ----------------- Past donors popup ----------------- */
async function loadDonors() {
  try {
    const res = await fetch('/donors');
    if (!res.ok) throw new Error('no donors endpoint');
    const donors = await res.json();
    return donors;
  } catch (err) {
    // fallback sample donors if not available
    return [
      {name:'Alice', amount:5, time: new Date().toISOString()},
      {name:'Bob', amount:10, time: new Date().toISOString()},
      {name:'Charlie', amount:2, time: new Date().toISOString()}
    ];
  }
}

async function refreshMiniDonors() {
  const donors = await loadDonors();
  const mini = document.getElementById('miniDonors');
  mini.innerHTML = donors.slice(0,4).map(d => `<li style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #f1f5f9;"><span>${escapeHtml(d.name || 'Anon')}</span><strong>A$${Number(d.amount).toFixed(2)}</strong></li>`).join('');
}
refreshMiniDonors();

async function showDonors() {
  const donors = await loadDonors();
  const list = document.getElementById('donorList');
  list.innerHTML = donors.map(d => `<li><span>${escapeHtml(d.name||'Anonymous')}</span><span style="font-weight:600;">A$${Number(d.amount).toFixed(2)}</span></li>`).join('');
  document.getElementById('popupOverlay').style.display = 'block';
  document.getElementById('donorPopup').style.display = 'block';
}

function closePopup() {
  document.getElementById('popupOverlay').style.display = 'none';
  document.getElementById('donorPopup').style.display = 'none';
}

/* escape helper */
function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s])); }

/* ----------------- Stripe Payment Element ----------------- */
const PUBLISHABLE_KEY = '<YOUR_STRIPE_PUBLISHABLE_KEY>'; // replace or set via simple templating
if (PUBLISHABLE_KEY && PUBLISHABLE_KEY.indexOf('pk_')===0) {
  const stripeClient = Stripe(PUBLISHABLE_KEY);
  let elements;
  async function initialize() {
    // amount input in AUD cents for demo
    const amountInput = document.getElementById('amount');
    amountInput.value = 5000; // default 50.00 AUD (in cents)
    // create PaymentIntent on the server
    const resp = await fetch('/create-payment-intent', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ amount: Number(amountInput.value), currency: 'aud' })
    });
    const { clientSecret } = await resp.json();
    const appearance = { theme: 'stripe' };
    elements = stripeClient.elements({ appearance, clientSecret });
    const paymentElement = elements.create('payment', { layout: 'accordion' });
    paymentElement.mount('#payment-element');
  }

  document.querySelector('#payment-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const amountVal = Number(document.getElementById('amount').value) || 5000;
    // create a new PaymentIntent with the amount when user submits
    const resp = await fetch('/create-payment-intent', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ amount: amountVal, currency: 'aud' })
    });
    const { clientSecret } = await resp.json();
    // re-init elements with new clientSecret
    const appearance = { theme: 'stripe' };
    const stripeEl = Stripe(PUBLISHABLE_KEY);
    const newElements = stripeEl.elements({ appearance, clientSecret });
    const newPaymentElement = newElements.create('payment', { layout: 'accordion' });
    document.getElementById('payment-element').innerHTML = '';
    newPaymentElement.mount('#payment-element');

    // confirm payment
    const { error } = await stripeEl.confirmPayment({
      elements: newElements,
      confirmParams: { return_url: window.location.href } // return back here after 3DS if needed
    });

    if (error) {
      const msg = document.getElementById('payment-message');
      msg.style.display = 'block';
      msg.textContent = error.message;
    } else {
      // for synchronous errors or a redirect will happen; we show a friendly message
      const msg = document.getElementById('payment-message');
      msg.style.display = 'block';
      msg.textContent = 'Payment processing... If you were redirected, return here to see status.';
    }
  });

  // attempt initialization (wrapped in try so it doesn't break when key not set)
  try { initialize(); }
  catch(e){ console.warn('Stripe init failed', e); }

} else {
  // hide payment element if no publishable key
  document.getElementById('paymentCard').style.display = 'none';
}

/* helper to scroll to payment area */
function scrollToPayment(){
  const el = document.getElementById('paymentCard');
  if (!el) return;
  el.scrollIntoView({behavior:'smooth', block:'center'});
}
</script>
</body>
</html>
